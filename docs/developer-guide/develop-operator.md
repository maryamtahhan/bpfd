# Developing the bpfman-operator

This section is intended to give developer level details regarding the layout and design of the bpfman-operator.
At its core the operator was implemented using the [operator-sdk framework](https://sdk.operatorframework.io/)
which make those docs another good resource if anything is missed here.

## High level design overview

This repository houses two main processes, the `bpfman-agent` and the `bpfman-operator` along with CRD api definitions
for `BpfProgram` and `*Program` Objects.
The following diagram depicts how all these components work together to create a functioning operator.

![bpfman on K8s](../img/bpfman-on-k8s.png)

## Building and deploying

For building and deploying the bpfman-operator simply see the attached `Make help`
output.

```bash
make help

Usage:
  make <target>

General
  help             Display this help.

Local Dependencies
  kustomize        Download kustomize locally if necessary.
  controller-gen   Download controller-gen locally if necessary.
  envtest          Download envtest-setup locally if necessary.
  opm              Download opm locally if necessary.

Development
  manifests        Generate WebhookConfiguration, ClusterRole and CustomResourceDefinition objects.
  generate         Generate ALL auto-generated code.
  generate-register  Generate register code see all `zz_generated.register.go` files.
  generate-deepcopy  Generate code containing DeepCopy, DeepCopyInto, and DeepCopyObject method implementations see all `zz_generated.register.go` files.
  generate-typed-clients  Generate typed client code
  generate-typed-listers  Generate typed listers code
  generate-typed-informers  Generate typed informers code
  fmt              Run go fmt against code.
  verify           Verify all the autogenerated code
  test             Run Unit tests.
  test-integration  Run Integration tests.
  bundle           Generate bundle manifests and metadata, then validate generated files.
  build-release-yamls  Generate the crd install bundle for a specific release version.

Build
  build            Build bpfman-operator and bpfman-agent binaries.
  build-images     Build bpfman, bpfman-agent, and bpfman-operator images.
  push-images      Push bpfman, bpfman-agent, bpfman-operator images.
  load-images-kind  Load bpfman, bpfman-agent, and bpfman-operator images into the running local kind devel cluster.
  bundle-build     Build the bundle image.
  bundle-push      Push the bundle image.
  catalog-build    Build a catalog image.
  catalog-push     Push a catalog image.

CRD Deployment
  install          Install CRDs into the K8s cluster specified in ~/.kube/config.
  uninstall        Uninstall CRDs from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.

Vanilla K8s Deployment
  setup-kind       Setup Kind cluster
  deploy           Deploy bpfman-operator to the K8s cluster specified in ~/.kube/config with the csi driver initialized.
  undeploy         Undeploy bpfman-operator from the K8s cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.
  kind-reload-images  Reload locally build images into a kind cluster and restart the ds and deployment so they're picked up.
  run-on-kind      Kind Deploy runs the bpfman-operator on a local kind cluster using local builds of bpfman, bpfman-agent, and bpfman-operator

Openshift Deployment
  deploy-openshift  Deploy bpfman-operator to the Openshift cluster specified in ~/.kube/config.
  undeploy-openshift  Undeploy bpfman-operator from the Openshift cluster specified in ~/.kube/config. Call with ignore-not-found=true to ignore resource not found errors during deletion.
```

## Running Locally in KIND

To run locally in a kind cluster with an up to date build simply run:

```bash
make run-on-kind
```

The container images used for `bpfman`,`bpfman-agent`, and `bpfman-operator` can also be manually configured,
by default local image builds will be used for the kind deployment.

```bash
BPFMAN_IMG=<your/image/url> BPFMAN_AGENT_IMG=<your/image/url> BPFMAN_OPERATOR_IMG=<your/image/url> make run-on-kind
```

Then rebuild and load a fresh build run:

```bash
make kind-reload-images
```

Which will rebuild the bpfman-operator, bpfman-agent, and bpfman images and load them into the kind cluster.

## Testing Locally

To run all of the **Unit Tests** defined in the bpfman-operator controller code simply run `make test`.

To run **Integration Tests** locally:

1. Build the images locally with the `int-test` tag.

```bash
    BPFMAN_AGENT_IMG=quay.io/bpfman/bpfman-agent:int-test BPFMAN_IMG=quay.io/bpfman/bpfman:int-test BPFMAN_OPERATOR_IMG=quay.io/bpfman/bpfman-operator:int-test make build-images
```

2. Run the integration test suite.

```bash
    BPFMAN_AGENT_IMG=quay.io/bpfman/bpfman-agent:int-test BPFMAN_IMG=quay.io/bpfman/bpfman:int-test BPFMAN_OPERATOR_IMG=quay.io/bpfman/bpfman-operator:int-test make test-integration
```

Additionally the integration test can be configured with the following environment variables:

* **KEEP_TEST_CLUSTER**: If set to `true` the test cluster will not be torn down after the integration test
  suite completes.
* **USE_EXISTING_KIND_CLUSTER**: If this is set to the name of the existing kind cluster the integration test
  suite will use that cluster instead of creating a new one.

## Project Layout

The bpfman-operator project layout is guided by the recommendations from both the
[operator-sdk framework](https://sdk.operatorframework.io/docs/building-operators/golang/tutorial/#project-layout)
and the [standard golang project-layout](https://github.com/golang-standards/project-layout).
The following is a brief description of the main directories and their contents.

**NOTE: Bolded directories contain auto-generated code**


- **`/apis`**: Contains the K8s CRD api definitions(`*_types.go`) for each version along with the
  auto-generated register and deepcopy methods(`zz_generated.deepcopy.go` and `zz_generate_register.go`).
- `/bundle`: Contains the OLM bundle manifests and metadata for the operator.
  More details can be found in the operator-sdk documentation.
- `/cmd`: Contains the main entry-points for the bpfman-operator and bpfman-agent processes.
- `/config`: Contains the configuration files for launching the bpfman-operator on a cluster.
    - `/bpfman-deployment`: Contains static deployment yamls for the bpfman-daemon, this includes two containers,
      one for `bpfman` and the other for the `bpfman-agent`.
      This DaemonSet yaml is NOT deployed statically by kustomize, instead it's statically copied into the operator
      image which is then responsible for deploying and configuring the bpfman-daemon DaemonSet.
      Lastly, this directory also contains the default config used to configure the bpfman-daemon, along with the
      cert-manager certificates used to encrypt communication between the bpfman-agent and bpfman.
    - `/bpfman-operator-deployment:` Contains the static deployment yaml for the bpfman-operator. This is deployed
      statically by kustomize.
    - `/crd`: Contains the CRD manifests for all of the bpfman-operator APIs.
        - **`/bases`**: Is where the actual CRD definitions are stored.
        These definitions are auto-generated by [controller-gen](https://book.kubebuilder.io/reference/controller-gen.html).
    - `/default`: Contains the default deployment configuration for the bpfman-operator.
    - `/manifests`: Contains the bases for generating OLM manifests.
    - `/openshift`: Contains the Openshift specific deployment configuration for the bpfman-operator.
    - `/prometheus`: Contains the prometheus manifests used to deploy Prometheus to a cluster.
      At the time of writing this the bpfman-operator is NOT exposing any metrics to prometheus, but this is a future goal.
    - **`/rbac`**: Contains rbac yamls for getting bpfman and the bpfman-operator up and running on Kubernetes.
        **`/bpfman-agent`**: Contains the rbac yamls for the bpfman-agent.
        They are automatically generated by kubebuilder via build tags in the bpfman-agent controller code.
        **`/bpfman-operator`**: Contains the rbac yamls for the bpfman-operator.
        They are automatically generated by kubebuilder via build tags in the bpfman-operator controller code.
    - `/samples`: Contains sample CR definitions that can be deployed by users for each of our supported APIs.
    - `/scorecard`: Contains the scorecard manifests used to deploy scorecard to a cluster. At the time of writing
      this the bpfman-operator is NOT running any scorecard tests.
    - `/test`: Contains the test manifests used to deploy the bpfman-operator to a kind cluster for integration testing.
- `/controllers`: Contains the controller implementations for all of the bpfman-operator APIs.
  Each controller is responsible for reconciling the state of the cluster with the desired state defined by the user.
  This is where the source of truth for the auto-generated RBAC can be found, keep an eye out for
  `//+kubebuilder:rbac:groups=bpfman.io` comment tags.
    - `/bpfmanagent`: Contains the controller implementations which reconcile user created `*Program` types to multiple
      `BpfProgram` objects.
    - `/bpfmanoperator`: Contains the controller implementations which reconcile global `BpfProgram` object state back to
      the user by ensuring the user created `*Program` objects are reporting the correct status.
- `/hack`: Contains any scripts+static files used by the bpfman-operator to facilitate development.
- `/internal`: Contains all private library code and is used by the bpfman-operator and bpfman-agent controllers.
- **`/pkg`**: Contains all public library code this is consumed externally and internally.
    - **`/client`**: Contains the autogenerated clientset, informers and listers for all of the bpfman-operator APIs.
      These are autogenerated by the [k8s.io/code-generator project](https://github.com/kubernetes/code-generator),
      and can be consumed by users wishing to programmatically interact with bpfman specific APIs.
    - `/helpers`: Contains helper functions which can be consumed by users wishing to programmatically interact with
      bpfman specific APIs.
- `/test/integration`: Contains integration tests for the bpfman-operator.
  These tests are run against a kind cluster and are responsible for testing the bpfman-operator in a real cluster
  environment.
  It uses the [kubernetes-testing-framework project](https://github.com/Kong/kubernetes-testing-framework) to
  programmatically spin-up all of the required infrastructure for our unit tests.
- `Makefile`: Contains all of the make targets used to build, test, and generate code used by the bpfman-operator.


## Troubleshooting

### Metrics/Health port issues

If the ports are already in use then you need to try to rebuild the bpfman images from scratch with the right ports

```bash
# kubectl describe pods -n bpfman bpfman-daemon-4cs8d

Events:
  Type     Reason     Age                From               Message
  ----     ------     ----               ----               -------
  Normal   Scheduled  21s                default-scheduler  Successfully assigned bpfman/bpfman-daemon-4cs8d to wsfd-advnetlab47.anl.lab.eng.bos.redhat.com
  Normal   Pulling    21s                kubelet            Pulling image "quay.io/fedora/fedora-minimal:latest"
  Normal   Pulled     20s                kubelet            Successfully pulled image "quay.io/fedora/fedora-minimal:latest" in 207ms (207ms including waiting)
  Normal   Created    20s                kubelet            Created container mount-bpffs
  Normal   Started    20s                kubelet            Started container mount-bpffs
  Normal   Pulling    19s                kubelet            Pulling image "quay.io/bpfman/bpfman:latest"
  Normal   Started    17s                kubelet            Started container bpfman
  Normal   Created    17s                kubelet            Created container bpfman
  Normal   Pulled     17s                kubelet            Successfully pulled image "quay.io/bpfman/bpfman:latest" in 1.908s (1.908s including waiting)
  Normal   Pulling    17s                kubelet            Pulling image "quay.io/bpfman/bpfman-agent:latest"
  Normal   Pulled     14s                kubelet            Successfully pulled image "quay.io/bpfman/bpfman-agent:latest" in 2.977s (2.977s including waiting)
  Normal   Pulling    14s                kubelet            Pulling image "quay.io/bpfman/csi-node-driver-registrar:v2.9.0"
  Normal   Pulled     14s                kubelet            Successfully pulled image "quay.io/bpfman/csi-node-driver-registrar:v2.9.0" in 246ms (246ms including waiting)
  Normal   Created    14s                kubelet            Created container node-driver-registrar
  Normal   Started    14s                kubelet            Started container node-driver-registrar
  Warning  BackOff    11s (x2 over 12s)  kubelet            Back-off restarting failed container bpfman-agent in pod bpfman-daemon-4cs8d_bpfman(b0e1ffb4-811e-4843-9c6a-5f050a39a8f3)
  Normal   Created    0s (x3 over 14s)   kubelet            Created container bpfman-agent
  Normal   Started    0s (x3 over 14s)   kubelet            Started container bpfman-agent
  Normal   Pulled     0s (x2 over 13s)   kubelet            Container image "quay.io/bpfman/bpfman-agent:latest" already present on machine
```

```bash
# cat /var/log/pods/bpfman_bpfman-daemon-4cs8d_b0e1ffb4-811e-4843-9c6a-5f050a39a8f3/bpfman-agent/3.log
2024-01-11T04:11:06.859284438-05:00 stderr F {"level":"info","ts":"2024-01-11T09:11:06Z","logger":"controller-runtime.metrics","msg":"Metrics server is starting to listen","addr":":8080"}
2024-01-11T04:11:06.859563984-05:00 stderr F {"level":"error","ts":"2024-01-11T09:11:06Z","logger":"setup","msg":"unable to start manager","error":"error listening on :8081: listen tcp :8081: bind: address already in use","stacktrace":"main.main\n\t/usr/src/bpfman/bpfman-operator/cmd/bpfman-agent/main.go:100\nruntime.main\n\t/usr/local/go/src/runtime/proc.go:250"}
```
```

The solution is to replace references to `quay.io/bpfman/bpfman*` in the configuration files with `localhost:5000/bpfman*`

```bash
# make local-registry
# make REGISTRY=localhost:5000 NO-CACHE=--no-cache build-images
# make REGISTRY=localhost:5000 push-images
# make REGISTRY=localhost:5000 deploy
```
